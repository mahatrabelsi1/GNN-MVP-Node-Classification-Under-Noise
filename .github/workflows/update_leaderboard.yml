name: Update Leaderboard (on merge)

on:
  push:
    branches: ["main"]
    paths:
      - "submissions/inbox/**/predictions.csv"
      - "submissions/inbox/**/metadata.json"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install pandas scikit-learn numpy

      - name: Restore hidden test labels (secret)
        shell: bash
        env:
          P1: ${{ secrets.TEST_LABELS_B64_01 }}
          P2: ${{ secrets.TEST_LABELS_B64_02 }}
          P3: ${{ secrets.TEST_LABELS_B64_03 }}
          P4: ${{ secrets.TEST_LABELS_B64_04 }}
          P5: ${{ secrets.TEST_LABELS_B64_05 }}
          P6: ${{ secrets.TEST_LABELS_B64_06 }}
          P7: ${{ secrets.TEST_LABELS_B64_07 }}
          P8: ${{ secrets.TEST_LABELS_B64_08 }}
        run: |
          set -e
          mkdir -p data/private
          if [ -z "$P1$P2$P3$P4$P5$P6$P7$P8" ]; then
            echo "ERROR: Missing secrets TEST_LABELS_B64_01..08"
            exit 1
          fi
          printf "%s%s%s%s%s%s%s%s" "$P1" "$P2" "$P3" "$P4" "$P5" "$P6" "$P7" "$P8" | base64 -d > data/private/test_labels.csv
          test -s data/private/test_labels.csv

      - name: Update leaderboard (score all submissions)
        run: |
          set -e
          python scoring/update_leaderboard_all.py

      - name: Copy leaderboard CSV into docs for GitHub Pages
        run: |
          set -e
          mkdir -p docs
          cp leaderboard/leaderboard.csv docs/leaderboard.csv

      - name: Commit leaderboard
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep -qE "(leaderboard/leaderboard\.(csv|md)|docs/leaderboard\.csv)"; then
            git add leaderboard/leaderboard.csv leaderboard/leaderboard.md docs/leaderboard.csv
            git commit -m "Update leaderboard"
            git push
          else
            echo "No leaderboard changes to commit."
          fi
