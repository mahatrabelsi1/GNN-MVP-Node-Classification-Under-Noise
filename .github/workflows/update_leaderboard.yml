name: Update Leaderboard (on merge)

on:
  push:
    branches: ["main"]
    paths:
      - "submissions/inbox/**/predictions.csv"
      - "submissions/inbox/**/metadata.json"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install pandas scikit-learn numpy

      - name: Restore hidden test labels (secret)
        run: |
          set -e
          mkdir -p data/private
          echo "${{ secrets.TEST_LABELS_B64 }}" | base64 -d > data/private/test_labels.csv
          test -s data/private/test_labels.csv

      - name: Detect merged submission file
        id: detect
        run: |
          set -e

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # Edge case: first push or missing "before"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="$(git rev-parse ${AFTER}~1)"
          fi

          echo "Diff range: $BEFORE..$AFTER"
          CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          echo "$CHANGED"

          PREDS="$(echo "$CHANGED" | grep -E '^submissions/inbox/.+/predictions\.csv$' || true)"
          METAS="$(echo "$CHANGED" | grep -E '^submissions/inbox/.+/metadata\.json$' || true)"

          PRED_COUNT="$(echo "$PREDS" | sed '/^\s*$/d' | wc -l | tr -d ' ')"
          META_COUNT="$(echo "$METAS" | sed '/^\s*$/d' | wc -l | tr -d ' ')"

          echo "pred_count=$PRED_COUNT"
          echo "meta_count=$META_COUNT"

          # Enforce exactly one submission per push to main
          if [ "$PRED_COUNT" -ne 1 ] || [ "$META_COUNT" -ne 1 ]; then
            echo "ERROR: This push must include exactly 1 predictions.csv and 1 metadata.json change."
            echo "predictions:"
            echo "$PREDS"
            echo "metadata:"
            echo "$METAS"
            exit 1
          fi

          PRED_PATH="$(echo "$PREDS" | head -n 1)"
          META_PATH="$(echo "$METAS" | head -n 1)"

          # Ensure both are in the same folder
          PRED_DIR="$(dirname "$PRED_PATH")"
          META_DIR="$(dirname "$META_PATH")"
          if [ "$PRED_DIR" != "$META_DIR" ]; then
            echo "ERROR: predictions.csv and metadata.json are not in the same folder."
            echo "pred_dir=$PRED_DIR"
            echo "meta_dir=$META_DIR"
            exit 1
          fi

          echo "pred_path=$PRED_PATH" >> $GITHUB_OUTPUT
          echo "meta_path=$META_PATH" >> $GITHUB_OUTPUT

      - name: Update leaderboard for merged submission
        run: |
          set -e
          python scoring/update_leaderboard.py --pred "${{ steps.detect.outputs.pred_path }}"

      - name: Copy leaderboard CSV into docs for GitHub Pages
        run: |
          set -e
          mkdir -p docs
          cp leaderboard/leaderboard.csv docs/leaderboard.csv

      - name: Commit leaderboard
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit if leaderboard files OR docs copy changed
          if git status --porcelain | grep -qE "(leaderboard/leaderboard\.(csv|md)|docs/leaderboard\.csv)"; then
            git add leaderboard/leaderboard.csv leaderboard/leaderboard.md docs/leaderboard.csv
            git commit -m "Update leaderboard"
            git push
          else
            echo "No leaderboard changes to commit."
          fi
