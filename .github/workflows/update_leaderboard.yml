name: Rebuild Leaderboard (manual)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install pandas scikit-learn numpy cryptography

      - name: Restore hidden test labels (secret)
        shell: bash
        env:
          P1: ${{ secrets.TEST_LABELS_B64_01 }}
          P2: ${{ secrets.TEST_LABELS_B64_02 }}
          P3: ${{ secrets.TEST_LABELS_B64_03 }}
          P4: ${{ secrets.TEST_LABELS_B64_04 }}
          P5: ${{ secrets.TEST_LABELS_B64_05 }}
          P6: ${{ secrets.TEST_LABELS_B64_06 }}
          P7: ${{ secrets.TEST_LABELS_B64_07 }}
          P8: ${{ secrets.TEST_LABELS_B64_08 }}
        run: |
          set -e
          mkdir -p data/private
          if [ -z "$P1$P2$P3$P4$P5$P6$P7$P8" ]; then
            echo "ERROR: Missing secrets TEST_LABELS_B64_01..08"
            exit 1
          fi
          printf "%s%s%s%s%s%s%s%s" "$P1" "$P2" "$P3" "$P4" "$P5" "$P6" "$P7" "$P8" | base64 -d > data/private/test_labels.csv
          test -s data/private/test_labels.csv

      - name: Restore submission private key (secret)
        shell: bash
        env:
          K1: ${{ secrets.SUBMISSION_PRIVATE_KEY_B64_01 }}
          K2: ${{ secrets.SUBMISSION_PRIVATE_KEY_B64_02 }}
          K3: ${{ secrets.SUBMISSION_PRIVATE_KEY_B64_03 }}
          K4: ${{ secrets.SUBMISSION_PRIVATE_KEY_B64_04 }}
          K5: ${{ secrets.SUBMISSION_PRIVATE_KEY_B64_05 }}
          K6: ${{ secrets.SUBMISSION_PRIVATE_KEY_B64_06 }}
          K7: ${{ secrets.SUBMISSION_PRIVATE_KEY_B64_07 }}
          K8: ${{ secrets.SUBMISSION_PRIVATE_KEY_B64_08 }}
        run: |
          set -e
          mkdir -p data/private
          if [ -z "$K1$K2$K3$K4$K5$K6$K7$K8" ]; then
            echo "ERROR: Missing secrets SUBMISSION_PRIVATE_KEY_B64_01..08"
            exit 1
          fi
          printf "%s%s%s%s%s%s%s%s" "$K1" "$K2" "$K3" "$K4" "$K5" "$K6" "$K7" "$K8" | base64 -d > data/private/submission_private_key.pem
          test -s data/private/submission_private_key.pem

      - name: Rebuild leaderboard from existing submissions
        run: |
          set -e
          python scoring/update_leaderboard_all_encrypted.py
          cp leaderboard/leaderboard.csv docs/leaderboard.csv

      - name: Commit rebuilt leaderboard
        shell: bash
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep -qE "(leaderboard/leaderboard\.(csv|md)|docs/leaderboard\.csv)"; then
            git add leaderboard/leaderboard.csv leaderboard/leaderboard.md docs/leaderboard.csv
            git commit -m "Rebuild leaderboard"
            git push origin main
          else
            echo "No leaderboard changes to commit."
          fi
